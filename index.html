<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trebuchet Volume Bar</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --ink:#e8ecff;
      --muted:#9aa6d6;
      --bar:#2a3566;
      --barFill:#7aa2ff;
      --accent:#ffd166;
      --danger:#ff5c7a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 40% -20%, #1a2a6b33, transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, #ff5c7a22, transparent 55%),
                  var(--bg);
      color:var(--ink);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{
      width:min(1000px, 100%);
      display:grid;
      gap:16px;
    }
    .top{
      display:flex;
      gap:12px;
      align-items:baseline;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{
      font-size: clamp(20px, 3vw, 28px);
      margin:0;
      letter-spacing:0.2px;
    }
    .sub{
      color:var(--muted);
      font-size:14px;
      margin:0;
    }
    .panel{
      background: linear-gradient(180deg, #111a33, #0e1630);
      border: 1px solid #233063;
      border-radius: 18px;
      box-shadow: 0 18px 40px #00000055;
      overflow:hidden;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr;
    }
    canvas{
      display:block;
      width:100%;
      height:auto;
      aspect-ratio: 16 / 7;
      background: radial-gradient(800px 500px at 40% 10%, #22336a55, transparent 60%),
                  radial-gradient(600px 450px at 90% 30%, #ff5c7a22, transparent 60%),
                  linear-gradient(180deg, #0b1020, #070b16);
    }
    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-top:1px solid #233063;
      flex-wrap:wrap;
    }
    .pill{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      background:#0b1020aa;
      border:1px solid #233063;
      border-radius:999px;
    }
    .pill b{font-variant-numeric: tabular-nums;}
    .btn{
      appearance:none;
      border:1px solid #2a3566;
      background:#0b1020;
      color:var(--ink);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease;
    }
    .btn:hover{background:#0f1630}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color:#3b55aa;background:#11204a}
    .btn.primary:hover{background:#15275a}
    .hint{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      padding: 0 16px 14px 16px;
    }
    .hint code{background:#0b1020aa;border:1px solid #233063;padding:2px 6px;border-radius:8px}
    .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Trebuchet Volume Bar</h1>
        <p class="sub">Pull back the arm → release to launch → the cannonball impact sets the volume.</p>
      </div>
      <div class="pill" aria-live="polite">
        <span>Volume</span>
        <b id="volText">0.50</b>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <canvas id="c" width="1200" height="525" aria-label="Trebuchet volume control" role="img"></canvas>
      </div>
      <div class="controls">
        <div class="pill">
          <span>Sound</span>
          <button class="btn primary" id="toggleAudio" type="button">Start</button>
          <span class="sub" id="audioState">(silent until started)</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="btn" id="reset" type="button">Reset shot</button>
          <button class="btn" id="center" type="button">Shoot to 50%</button>
        </div>
      </div>
      <div class="hint">
        <div><b>How it works:</b> drag near the rope/hand on the trebuchet arm to pull back. Release to fire.</div>
        <div>Tip: bigger pullback = faster shot. The volume updates when the cannonball crosses the bar.</div>
      </div>
    </div>

    <div class="sr-only" id="a11y">Trebuchet volume control. Drag to pull back and release to set volume.</div>
  </div>

  <script>
    // --- Trebuchet + physics volume setter + medieval flute background ---
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const volText = document.getElementById('volText');

    // ===== Audio: medieval flute-ish background (synth) =====
    let audioCtx = null;
    let master = null;
    const bg = { intervalId: null, nextNoteTime: 0, step: 0, tempo: 96 };

    function setVolume(v){
      v = Math.max(0, Math.min(1, v));
      state.volume = v;
      volText.textContent = v.toFixed(2);
      if(master) master.gain.value = v;
    }

    function makeFluteVoice(t, freq, dur){
      // Flute-ish: sine + filtered breath noise + vibrato + light delay
      const o = audioCtx.createOscillator();
      o.type = 'sine';
      o.frequency.setValueAtTime(freq, t);

      const lfo = audioCtx.createOscillator();
      lfo.type = 'sine';
      lfo.frequency.setValueAtTime(5.2, t);
      const lfoGain = audioCtx.createGain();
      lfoGain.gain.setValueAtTime(6.5, t);
      lfo.connect(lfoGain);
      lfoGain.connect(o.frequency);

      const noiseDur = Math.max(0.05, dur);
      const noiseBuf = audioCtx.createBuffer(1, Math.floor(audioCtx.sampleRate * noiseDur), audioCtx.sampleRate);
      const data = noiseBuf.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * 0.32;
      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuf;

      const bp = audioCtx.createBiquadFilter();
      bp.type = 'bandpass';
      bp.frequency.setValueAtTime(Math.max(650, Math.min(1900, freq*2.1)), t);
      bp.Q.setValueAtTime(2.1, t);

      const vca = audioCtx.createGain();
      const a = 0.02, d = 0.09, s = 0.55, r = Math.min(0.18, dur*0.35);
      vca.gain.setValueAtTime(0.0001, t);
      vca.gain.exponentialRampToValueAtTime(0.9, t + a);
      vca.gain.exponentialRampToValueAtTime(0.9*s, t + a + d);
      vca.gain.setValueAtTime(0.9*s, t + Math.max(0, dur - r));
      vca.gain.exponentialRampToValueAtTime(0.0001, t + dur);

      const delay = audioCtx.createDelay(0.6);
      delay.delayTime.setValueAtTime(0.22, t);
      const fb = audioCtx.createGain();
      fb.gain.setValueAtTime(0.26, t);
      delay.connect(fb);
      fb.connect(delay);

      const mix = audioCtx.createGain();
      mix.gain.setValueAtTime(0.9, t);

      o.connect(vca);
      noise.connect(bp);
      bp.connect(vca);

      vca.connect(mix);
      mix.connect(master);
      mix.connect(delay);
      delay.connect(master);

      o.start(t);
      noise.start(t);
      lfo.start(t);
      const stopT = t + dur + 0.03;
      o.stop(stopT);
      noise.stop(stopT);
      lfo.stop(stopT);
    }

    function scheduleBackground(){
      // D Dorian-ish scale (D E F G A B C D)
      const scale = [293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25, 587.33];
      const motif = [0,2,3,4,3,2,1,0, 0,1,2,3,2,1,0,0, 4,5,4,3,2,3,4,3];
      const beat = 60 / bg.tempo;

      const now = audioCtx.currentTime;
      const scheduleAhead = 0.7;
      if(bg.nextNoteTime < now) bg.nextNoteTime = now + 0.05;

      while(bg.nextNoteTime < now + scheduleAhead){
        const idx = motif[bg.step % motif.length];
        const freq = scale[idx];
        const isLong = (bg.step % 8 === 7) || (bg.step % 12 === 11);
        const dur = (isLong ? 1.5 : 1.0) * beat;
        makeFluteVoice(bg.nextNoteTime, freq, dur * 0.92);
        bg.nextNoteTime += dur;
        bg.step++;
      }
    }

    async function startAudio(){
      if(audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      master = audioCtx.createGain();
      master.gain.value = state.volume;
      master.connect(audioCtx.destination);

      bg.step = 0;
      bg.nextNoteTime = audioCtx.currentTime + 0.08;
      bg.intervalId = setInterval(scheduleBackground, 100);
      scheduleBackground();
    }

    function stopAudio(){
      if(!audioCtx) return;
      if(bg.intervalId) clearInterval(bg.intervalId);
      bg.intervalId = null;
      try{ master.disconnect(); }catch{}
      master = null;
      audioCtx.close();
      audioCtx = null;
    }

    const toggleBtn = document.getElementById('toggleAudio');
    const audioState = document.getElementById('audioState');
    toggleBtn.addEventListener('click', async ()=>{
      if(!audioCtx){
        await startAudio();
        toggleBtn.textContent = 'Stop';
        audioState.textContent = '(medieval flute playing)';
      } else {
        stopAudio();
        toggleBtn.textContent = 'Start';
        audioState.textContent = '(silent until started)';
      }
    });

    // ===== Canvas sizing for crispness =====
    function fitCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const cssW = canvas.clientWidth || 900;
      const cssH = canvas.clientHeight || 450;
      canvas.width = Math.round(cssW * dpr);
      canvas.height = Math.round(cssH * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS px
    }
    window.addEventListener('resize', fitCanvas);

    // ===== World state (all in CSS px) =====
    const state = {
      volume: 0.50,
      dragging: false,
      fired: false,
      impacted: false,
      base: {x: 150, y: 380},
      pivot: {x: 210, y: 270},
      armLen: 170,
      slingLen: 70,
      armAngle: -0.15,
      restAngle: -0.15,
      pullAngle: -1.25,
      ball: {x: 0, y: 0, vx: 0, vy: 0, r: 10},
      gravity: 900,
      lastT: 0,
      bar: {x: 300, y: 115, w: 820, h: 22},
      pointer: null,
    };

    function armHandPos(){
      const a = state.armAngle;
      return { x: state.pivot.x + Math.cos(a) * state.armLen,
               y: state.pivot.y + Math.sin(a) * state.armLen };
    }

    function slingEndPos(hand){
      const sAng = Math.PI/2 + (state.armAngle * 0.25);
      return { x: hand.x + Math.cos(sAng) * state.slingLen,
               y: hand.y + Math.sin(sAng) * state.slingLen };
    }

    function placeBallAtSling(){
      const hand = armHandPos();
      const sling = slingEndPos(hand);
      state.ball.x = sling.x;
      state.ball.y = sling.y;
      state.ball.vx = 0;
      state.ball.vy = 0;
    }

    function resetShot(){
      state.fired = false;
      state.impacted = false;
      state.armAngle = state.restAngle;
      placeBallAtSling();
    }

    document.getElementById('reset').addEventListener('click', resetShot);
    document.getElementById('center').addEventListener('click', ()=>{
      if(state.fired) resetShot();
      state.fired = true;
      state.impacted = false;
      const target = state.bar.x + state.bar.w * 0.5;
      const start = {x: state.ball.x, y: state.ball.y};
      const dx = target - start.x;
      const dy = (state.bar.y + state.bar.h/2) - start.y;
      const t = Math.max(0.65, Math.min(1.1, Math.abs(dx)/600));
      state.ball.vx = dx / t;
      state.ball.vy = (dy - 0.5*state.gravity*t*t) / t;
    });

    function getPointer(e){
      const r = canvas.getBoundingClientRect();
      return {x: e.clientX - r.left, y: e.clientY - r.top};
    }

    function dist(a,b){
      return Math.hypot(a.x-b.x, a.y-b.y);
    }

    // ===== Interaction: easier pull to 100% =====
    canvas.addEventListener('pointerdown', (e)=>{
      if(state.fired) return;
      canvas.setPointerCapture(e.pointerId);
      const p = getPointer(e);
      const hand = armHandPos();
      const sling = slingEndPos(hand);
      const grabPoint = {x: (hand.x + sling.x)/2, y: (hand.y + sling.y)/2};
      if(dist(p, grabPoint) < 78){
        state.dragging = true;
      }
    });

    canvas.addEventListener('pointermove', (e)=>{
      const p = getPointer(e);
      state.pointer = p;
      if(!state.dragging || state.fired) return;

      // Use left drag AND down drag to accumulate pull.
      const dx = Math.max(0, (state.pivot.x - p.x));
      const dy = Math.max(0, (p.y - state.pivot.y));
      const pull = Math.max(0, Math.min(1, (dx/130) * 0.75 + (dy/170) * 0.45));

      state.armAngle = state.restAngle + (state.pullAngle - state.restAngle) * pull;
      placeBallAtSling();
    });

    canvas.addEventListener('pointerup', ()=>{
      if(!state.dragging || state.fired) return;
      state.dragging = false;

      const pullAmt = (state.restAngle - state.armAngle) / (state.restAngle - state.pullAngle);
      const power = Math.max(0.05, Math.min(1, pullAmt));

      const hand = armHandPos();
      const sling = slingEndPos(hand);
      const start = {x: sling.x, y: sling.y};

      const dirAng = state.armAngle + 0.55;
      const speed = 520 + 980 * power;

      state.ball.x = start.x;
      state.ball.y = start.y;
      state.ball.vx = Math.cos(dirAng) * speed;
      state.ball.vy = Math.sin(dirAng) * speed;

      state.fired = true;
      state.impacted = false;
      state.armAngle = state.restAngle;
    });

    // ===== Drawing =====
    function roundRect(x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr,y);
      ctx.arcTo(x+w,y,x+w,y+h,rr);
      ctx.arcTo(x+w,y+h,x,y+h,rr);
      ctx.arcTo(x,y+h,x,y,rr);
      ctx.arcTo(x,y,x+w,y,rr);
      ctx.closePath();
    }

    function drawBar(){
      const {x,y,w,h} = state.bar;
      ctx.save();
      ctx.globalAlpha = 0.95;
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bar').trim();
      roundRect(x, y, w, h, 12);
      ctx.fill();

      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--barFill').trim();
      roundRect(x, y, w * state.volume, h, 12);
      ctx.fill();

      ctx.globalAlpha = 0.25;
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 1;
      for(let i=0;i<=10;i++){
        const tx = x + (w*i/10);
        ctx.beginPath();
        ctx.moveTo(tx, y+h+6);
        ctx.lineTo(tx, y+h+ (i%5===0?18:12));
        ctx.stroke();
      }

      ctx.globalAlpha = 1;
      const kx = x + w * state.volume;
      const ky = y + h/2;
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
      ctx.beginPath();
      ctx.arc(kx, ky, 10, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = '#e8ecff';
      ctx.font = '600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('VOLUME', x, y-12);
      ctx.restore();
    }

    function drawTrebuchet(){
      const base = state.base;
      const pivot = state.pivot;
      const hand = armHandPos();
      const sling = slingEndPos(hand);

      ctx.save();
      // ground
      ctx.globalAlpha = 0.45;
      ctx.strokeStyle = '#2a3566';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(0, base.y+40);
      ctx.lineTo(canvas.clientWidth || 1000, base.y+40);
      ctx.stroke();
      ctx.globalAlpha = 1;

      // frame
      ctx.strokeStyle = '#c2c9ff';
      ctx.lineWidth = 6;
      ctx.lineCap = 'round';

      ctx.beginPath();
      ctx.moveTo(base.x, base.y);
      ctx.lineTo(pivot.x-50, pivot.y+40);
      ctx.lineTo(pivot.x, pivot.y);
      ctx.lineTo(pivot.x+55, pivot.y+45);
      ctx.lineTo(base.x+120, base.y);
      ctx.stroke();

      ctx.strokeStyle = '#a7b1ff';
      ctx.lineWidth = 8;
      ctx.beginPath();
      ctx.moveTo(base.x-10, base.y);
      ctx.lineTo(base.x+140, base.y);
      ctx.stroke();

      // pivot
      ctx.fillStyle = '#ffd166';
      ctx.beginPath();
      ctx.arc(pivot.x, pivot.y, 10, 0, Math.PI*2);
      ctx.fill();

      // arm
      ctx.strokeStyle = '#e8ecff';
      ctx.lineWidth = 8;
      ctx.beginPath();
      ctx.moveTo(pivot.x, pivot.y);
      ctx.lineTo(hand.x, hand.y);
      ctx.stroke();

      // counterweight
      const cwAng = state.armAngle - Math.PI + 0.2;
      const cw = { x: pivot.x + Math.cos(cwAng) * 55,
                   y: pivot.y + Math.sin(cwAng) * 55 };
      ctx.fillStyle = '#ff5c7a';
      ctx.globalAlpha = 0.85;
      roundRect(cw.x-18, cw.y-18, 36, 36, 10);
      ctx.fill();
      ctx.globalAlpha = 1;

      // sling
      ctx.strokeStyle = '#9aa6d6';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(hand.x, hand.y);
      ctx.lineTo(sling.x, sling.y);
      ctx.stroke();

      // grab hint
      if(!state.fired){
        const grab = {x:(hand.x+sling.x)/2, y:(hand.y+sling.y)/2};
        ctx.fillStyle = 'rgba(255, 209, 102, 0.2)';
        ctx.beginPath();
        ctx.arc(grab.x, grab.y, 28, 0, Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = 'rgba(255, 209, 102, 0.65)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(grab.x, grab.y, 28, 0, Math.PI*2);
        ctx.stroke();
      }

      ctx.restore();
    }

    function drawBall(){
      const b = state.ball;
      ctx.save();
      ctx.globalAlpha = 0.22;
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.ellipse(b.x, state.base.y+34, b.r*1.2, b.r*0.55, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;

      const g = ctx.createRadialGradient(b.x-4, b.y-6, 3, b.x, b.y, b.r+8);
      g.addColorStop(0, '#ffffff');
      g.addColorStop(0.15, '#cfd6ff');
      g.addColorStop(1, '#6b79b8');
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      ctx.fill();

      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.restore();
    }

    function drawAiming(){
      if(!state.pointer || state.fired) return;
      const p = state.pointer;
      const {x,y,w,h} = state.bar;
      if(p.x < x || p.x > x+w || p.y < y-50 || p.y > y+h+50) return;
      ctx.save();
      ctx.globalAlpha = 0.35;
      ctx.strokeStyle = '#ffd166';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(p.x, y-18);
      ctx.lineTo(p.x, y+h+18);
      ctx.stroke();
      ctx.restore();
    }

    function checkImpact(){
      if(state.impacted) return;
      const b = state.ball;
      const {x,y,w,h} = state.bar;
      const inX = (b.x >= x - b.r) && (b.x <= x + w + b.r);
      const inY = (b.y >= y - b.r) && (b.y <= y + h + b.r);
      if(inX && inY){
        state.impacted = true;
        const v = (b.x - x) / w;
        setVolume(v);
        state.ball.vx *= 0.3;
        state.ball.vy *= -0.25;
      }
    }

    function step(t){
      if(!state.lastT) state.lastT = t;
      const dt = Math.min(0.033, (t - state.lastT) / 1000);
      state.lastT = t;

      if(!state.fired){
        placeBallAtSling();
      } else {
        state.ball.vy += state.gravity * dt;
        state.ball.x += state.ball.vx * dt;
        state.ball.y += state.ball.vy * dt;

        const ground = state.base.y + 30;
        if(state.ball.y + state.ball.r > ground){
          state.ball.y = ground - state.ball.r;
          state.ball.vy *= -0.45;
          state.ball.vx *= 0.75;
          if(Math.abs(state.ball.vy) < 40) state.ball.vy = 0;
          if(Math.abs(state.ball.vx) < 20) state.ball.vx = 0;
        }

        const maxX = (canvas.clientWidth || 1000) - 20;
        if(state.ball.x < 20){ state.ball.x = 20; state.ball.vx *= -0.6; }
        if(state.ball.x > maxX){ state.ball.x = maxX; state.ball.vx *= -0.6; }

        checkImpact();
      }

      // draw
      ctx.clearRect(0,0,canvas.clientWidth || 1000, canvas.clientHeight || 600);

      ctx.save();
      ctx.globalAlpha = 0.25;
      ctx.fillStyle = '#ffffff';
      const w = canvas.clientWidth || 1000;
      const h = canvas.clientHeight || 600;
      for(let i=0;i<50;i++){
        const sx = (i*97) % w;
        const sy = (i*53) % (h*0.45);
        ctx.fillRect(sx, sy, 2, 2);
      }
      ctx.restore();

      drawBar();
      drawAiming();
      drawTrebuchet();
      drawBall();

      ctx.save();
      ctx.fillStyle = 'rgba(232,236,255,0.85)';
      ctx.font = '600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      const msg = !state.fired ? 'Pull the sling to arm the shot' : (state.impacted ? 'Impact set the volume' : 'Cannonball in flight…');
      ctx.fillText(msg, 22, 28);
      ctx.restore();

      requestAnimationFrame(step);
    }

    // init
    fitCanvas();
    setVolume(state.volume);
    resetShot();
    requestAnimationFrame(step);
  </script>
</body>
</html>
